<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>XML Comparator</title>
    <style>
        /* same styles as before */
        * {
            box-sizing: border-box;
        }

        html,
        body {
            overflow: hidden;
        }

        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #e5e7eb;
            padding: 2rem;
        }

        .container {
            max-width: 1900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .file-inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .custom-file {
            position: relative;
            display: inline-block;
            width: 100%;
            max-width: 400px;
        }

        .custom-file input[type="file"] {
            display: none;
        }

        .custom-file-label {
            display: inline-block;
            width: 100%;
            padding: 1rem 1.5rem;
            font-size: 1rem;
            border: 2px dashed #ccc;
            border-radius: 8px;
            background-color: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .custom-file-label:hover {
            background-color: #e6f7ff;
            border-color: #1890ff;
            color: #1890ff;
        }

        .output {
            display: flex;
            flex-wrap: nowrap;
            gap: 1.2rem;
            overflow-x: auto;
            padding: 0 1rem;
        }

        .xml-display {
            flex: 1 1 50%;
            background: #f8f9fa;
            color: #333;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            overflow: auto;
            max-height: 80vh;
            white-space: pre;
            font-family: Consolas, monospace;
            font-size: 0.9rem;
        }

        #output1 {
            /* Remove padding-right and negative margin */
            padding-right: 0;
            margin-right: 0;
            overflow-y: auto;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        #output1::-webkit-scrollbar {
            display: none;
        }

        .diff-add {
            background-color: #e6ffed;
        }

        .diff-remove {
            background-color: #ffeef0;
        }

        .diff-change {
            background-color: #fff5b1;
        }

        .diff-change-word {
            background-color: #e2104f;
            /* dark orange */
            color: white;
            font-weight: bold;
            padding: 0 2px;
            border-radius: 2px;
        }

        @media (max-width: 768px) {
            .output {
                flex-wrap: wrap;
            }

            .xml-display {
                flex: 1 1 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>XML Comparator</h1>
            <p>Upload two XML files to compare them side by side.</p>
        </div>
        <div class="file-inputs">
            <div class="custom-file">
                <label class="custom-file-label" for="file1">Choose XML File 1</label>
                <input type="file" id="file1" accept=".xml" />
            </div>
            <div class="custom-file">
                <label class="custom-file-label" for="file2">Choose XML File 2</label>
                <input type="file" id="file2" accept=".xml" />
            </div>
        </div>
        <div class="output">
            <div class="xml-display" id="output1"></div>
            <div class="xml-display" id="output2"></div>
        </div>
    </div>

    <script>
        let xml1 = '', xml2 = '';

        document.getElementById('file1').addEventListener('change', function () {
            readFile(this, 1);
        });
        document.getElementById('file2').addEventListener('change', function () {
            readFile(this, 2);
        });

        function readFile(input, index) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                if (index === 1) xml1 = reader.result;
                else xml2 = reader.result;
                if (xml1 && xml2) showDiff(xml1, xml2);
            };
            reader.readAsText(file);
        }

        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, (m) => {
                switch (m) {
                    case '&': return '&amp;';
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '"': return '&quot;';
                    case "'": return '&#39;';
                }
            });
        }

        function highlightWordDiffs(line1, line2) {
            const tokenize = (line) =>
                line.match(/<\/?[\w:-]+|\/?>|[\w:-]+="[^"]*"|[\w:-]+|".*?"|\s+|[^\w\s]/g) || [];

            const tokens1 = tokenize(line1);
            const tokens2 = tokenize(line2);

            let html = '';
            let inHighlight = false;

            const isTag = (t) => /^<\/?[\w:-]+$/.test(t);
            const isSelfClose = (t) => /^\/?>$/.test(t);
            const isAttribute = (t) => /^[\w:-]+="[^"]*"$/.test(t);

            const splitAttribute = (attr) => {
                const match = attr.match(/^([\w:-]+)=(")([^"]*)(")$/);
                if (!match) return null;
                return { name: match[1], quote1: match[2], value: match[3], quote2: match[4] };
            };

            function diffInnerText(text1, text2) {
                let result = '';
                let inDiff = false;
                const maxLen = Math.max(text1.length, text2.length);
                for (let i = 0; i < maxLen; i++) {
                    const c1 = text1[i] || '';
                    const c2 = text2[i] || '';

                    if (c1 === c2) {
                        if (inDiff) {
                            result += '</span>';
                            inDiff = false;
                        }
                        result += escapeHTML(c1);
                    } else {
                        if (!inDiff) {
                            result += '<span class="diff-change-word">';
                            inDiff = true;
                        }
                        result += escapeHTML(c1);
                    }
                }
                if (inDiff) result += '</span>';
                return result;
            }

            for (let i = 0; i < tokens1.length; i++) {
                const t1 = tokens1[i];
                const t2 = tokens2[i] || '';

                if (isTag(t1) && isTag(t2)) {
                    if (t1 === t2) {
                        if (inHighlight) {
                            html += '</span>';
                            inHighlight = false;
                        }
                        html += escapeHTML(t1);
                    } else {
                        if (!inHighlight) {
                            html += '<span class="diff-change-word">';
                            inHighlight = true;
                        }
                        html += escapeHTML(t1);
                    }
                } else if (isAttribute(t1) && isAttribute(t2)) {
                    const attr1 = splitAttribute(t1);
                    const attr2 = splitAttribute(t2);

                    if (attr1 && attr2 && attr1.name === attr2.name) {
                        if (inHighlight) {
                            html += '</span>';
                            inHighlight = false;
                        }
                        html += escapeHTML(attr1.name) + '=' + attr1.quote1;
                        html += diffInnerText(attr1.value, attr2.value);
                        html += attr1.quote2;
                    } else {
                        if (!inHighlight) {
                            html += '<span class="diff-change-word">';
                            inHighlight = true;
                        }
                        html += escapeHTML(t1);
                    }
                } else if (!isTag(t1) && !isSelfClose(t1) && !isAttribute(t1)) {
                    if (t1 === t2) {
                        if (inHighlight) {
                            html += '</span>';
                            inHighlight = false;
                        }
                        html += escapeHTML(t1);
                    } else {
                        if (!inHighlight) {
                            html += '<span class="diff-change-word">';
                            inHighlight = true;
                        }
                        html += escapeHTML(t1);
                    }
                } else {
                    if (inHighlight) {
                        html += '</span>';
                        inHighlight = false;
                    }
                    html += escapeHTML(t1);
                }
            }

            if (inHighlight) html += '</span>';
            return html;
        }

        function alignLinesWithPadding(origA, origB) {
            const normA = origA.map(line => line.trim());
            const normB = origB.map(line => line.trim());

            const output = [];
            let i = 0, j = 0;

            while (i < origA.length || j < origB.length) {
                const lineA = origA[i] || '';
                const lineB = origB[j] || '';
                const normLineA = normA[i] || '';
                const normLineB = normB[j] || '';

                if (normLineA === normLineB) {
                    output.push([lineA, lineB]);
                    i++;
                    j++;
                } else if (!normLineA) {
                    output.push(['', lineB]);
                    j++;
                } else if (!normLineB) {
                    output.push([lineA, '']);
                    i++;
                } else {
                    let foundMatchInB = -1;
                    let foundMatchInA = -1;

                    for (let k = j + 1; k < normB.length; k++) {
                        if (normLineA === normB[k]) {
                            foundMatchInB = k;
                            break;
                        }
                    }

                    for (let k = i + 1; k < normA.length; k++) {
                        if (normLineB === normA[k]) {
                            foundMatchInA = k;
                            break;
                        }
                    }

                    if (foundMatchInB !== -1 && (foundMatchInA === -1 || foundMatchInB - j <= foundMatchInA - i)) {
                        while (j < foundMatchInB) {
                            output.push(['', origB[j]]);
                            j++;
                        }
                    } else if (foundMatchInA !== -1) {
                        while (i < foundMatchInA) {
                            output.push([origA[i], '']);
                            i++;
                        }
                    } else {
                        output.push([lineA, lineB]);
                        i++;
                        j++;
                    }
                }
            }

            return output;
        }

        function showDiff(text1, text2) {
            const lines1 = text1.split(/\r?\n/);
            const lines2 = text2.split(/\r?\n/);

            const diffs = alignLinesWithPadding(lines1, lines2);

            let html1 = '', html2 = '';
            diffs.forEach(([l1, l2]) => {
                const maxLen = Math.max(l1.length, l2.length);
                const paddedL1 = l1.padEnd(maxLen, ' ');
                const paddedL2 = l2.padEnd(maxLen, ' ');

                let class1 = '', class2 = '';
                let content1 = escapeHTML(paddedL1);
                let content2 = escapeHTML(paddedL2);

                if (l1.trim() === l2.trim()) {
                    class1 = class2 = '';
                } else if (!l1.trim()) {
                    class1 = 'diff-remove';
                    class2 = 'diff-add';
                } else if (!l2.trim()) {
                    class1 = 'diff-add';
                    class2 = 'diff-remove';
                } else {
                    class1 = class2 = 'diff-change';
                    content1 = highlightWordDiffs(l1, l2);
                    content2 = highlightWordDiffs(l2, l1);
                }

                html1 += `<div class="${class1}">${content1}</div>`;
                html2 += `<div class="${class2}">${content2}</div>`;
            });

            document.getElementById('output1').innerHTML = html1;
            document.getElementById('output2').innerHTML = html2;
        }

        // Sync scrolling
        const output1 = document.getElementById('output1');
        const output2 = document.getElementById('output2');
        function syncScroll(source, target) {
            target.scrollTop = source.scrollTop;
            target.scrollLeft = source.scrollLeft;
        }
        output1.addEventListener('scroll', () => syncScroll(output1, output2));
        output2.addEventListener('scroll', () => syncScroll(output2, output1));
    </script>
</body>

</html>
